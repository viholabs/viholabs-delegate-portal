name: HOLDed — Import Incremental (Invoices)

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch: {}

concurrency:
  group: holded-import-incremental-invoices
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Call import-incremental endpoint (Invoices)
        env:
          BASE_URL: ${{ secrets.VIHOLABS_PORTAL_BASE_URL }}
          BEARER: ${{ secrets.VIHOLABS_INTERNAL_BEARER }}
        run: |
          set -euo pipefail
          if [ -z "${BASE_URL:-}" ]; then
            echo "Missing secret: VIHOLABS_PORTAL_BASE_URL"
            exit 1
          fi
          if [ -z "${BEARER:-}" ]; then
            echo "Missing secret: VIHOLABS_INTERNAL_BEARER"
            exit 1
          fi

          BASE="${BASE_URL%/}"

          # Print host only (no path). This is safe and helps diagnosis.
          HOST_ONLY="$(echo "$BASE" | sed -E 's#^https?://##' | cut -d/ -f1)"
          echo "BASE_URL host = ${HOST_ONLY}"

          echo "PROBE 1 — GET / (follow redirects, show final URL + code)"
          curl -sS -L -D /tmp/h1.txt -o /dev/null \
            -w "final_url=%{url_effective} http_code=%{http_code}\n" \
            "${BASE}/" || true
          echo "headers:"
          tail -n 15 /tmp/h1.txt || true

          echo "PROBE 2 — GET /api/holded/poll (follow redirects, show final URL + code)"
          curl -sS -L -D /tmp/h2.txt -o /dev/null \
            -H "Authorization: Bearer ${BEARER}" \
            -H "Accept: application/json" \
            -w "final_url=%{url_effective} http_code=%{http_code}\n" \
            "${BASE}/api/holded/poll" || true
          echo "headers:"
          tail -n 15 /tmp/h2.txt || true

          URL="${BASE}/api/holded/invoices/import-incremental?limit=50"
          echo "Calling: $URL"
          curl -fSs -L \
            -H "Authorization: Bearer ${BEARER}" \
            -H "Accept: application/json" \
            -w "\nfinal_url=%{url_effective} http_code=%{http_code}\n" \
            "$URL" | tee response.json
          echo ""
          echo "OK — response.json written"
